<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HSSoC Contributor Leaderboard</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 2rem;
      background-color: #f9f9f9;
    }
    h1 {
      text-align: center;
      color: #222;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #007acc;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 1rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      border: 1px solid #ccc;
    }
    .loading {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: #666;
    }
    .error {
      color: #d9534f;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <h1>ðŸš€ HSSoC Contributor Leaderboard</h1>
  <input type="text" id="searchInput" placeholder="Search by GitHub username..." />
  <table id="leaderboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Username</th>
        <th>Total Contributions</th>
        <th>Repositories Contributed</th>
        <th>Profile</th>
      </tr>
    </thead>
    <tbody id="leaderboardBody">
      <tr>
        <td colspan="5" class="loading">Loading repositories and contributor data from GitHub...</td>
      </tr>
    </tbody>
  </table>

  <script>
    const tbody = document.getElementById("leaderboardBody");
    const searchInput = document.getElementById("searchInput");
    
    // Store aggregated contributor data
    let contributors = [];
    
    // Function to fetch all repositories from the organization
    async function fetchOrganizationRepos() {
      try {
        let allRepos = [];
        let page = 1;
        let hasMore = true;
        
        while (hasMore) {
          const response = await fetch(`https://api.github.com/orgs/HashSlap-Summer-of-Code/repos?per_page=1&page=${page}`);
          if (!response.ok) {
            throw new Error(`Failed to fetch repositories for organization`);
          }
          
          const repos = await response.json();
          if (repos.length === 0) {
            hasMore = false;
          } else {
            allRepos = allRepos.concat(repos.map(repo => repo.full_name));
            page++;
          }
        }
        
        return allRepos;
      } catch (error) {
        console.error("Error fetching organization repositories:", error);
        return [];
      }
    }
    
    // Function to fetch contributors from a single repository
    async function fetchRepoContributors(repo) {
      try {
        const response = await fetch(`https://api.github.com/repos/${repo}/contributors`);
        if (!response.ok) {
          console.warn(`No contributors found for ${repo} or repository is private`);
          return [];
        }
        return await response.json();
      } catch (error) {
        console.error(`Error fetching contributors for ${repo}:`, error);
        return [];
      }
    }
    
    // Function to aggregate contributor data from all repositories
    async function fetchAllContributors() {
      const allContributors = {};
      
      // First fetch all repositories from the organization
      const repos = await fetchOrganizationRepos();
      
      if (repos.length === 0) {
        throw new Error("No repositories found in the organization");
      }
      
      // Update loading message
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="loading">
            Found ${repos.length} repositories. Now loading contributor data...
          </td>
        </tr>
      `;
      
      // Fetch contributors for each repository
      for (const repo of repos) {
        const repoContributors = await fetchRepoContributors(repo);
        
        // Process contributors for this repository
        for (const contributor of repoContributors) {
          const username = contributor.login;
          
          if (!allContributors[username]) {
            allContributors[username] = {
              username: username,
              contributions: 0,
              repos: new Set(),
              profile: contributor.html_url
            };
          }
          
          // Add contributions and repository
          allContributors[username].contributions += contributor.contributions;
          allContributors[username].repos.add(repo.split('/')[1]);
        }
      }
      
      // Convert to array and sort by contributions
      return Object.values(allContributors)
        .map(c => ({
          ...c,
          repos: Array.from(c.repos)
        }))
        .sort((a, b) => b.contributions - a.contributions);
    }
    
    // Render the table with contributor data
    function renderTable(data) {
      tbody.innerHTML = "";
      
      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="error">No contributors found or error loading data.</td>
          </tr>
        `;
        return;
      }
      
      data.forEach((contributor, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${contributor.username}</td>
          <td>${contributor.contributions}</td>
          <td>${contributor.repos.join(", ")}</td>
          <td><a href="${contributor.profile}" target="_blank">View Profile</a></td>
        `;
        tbody.appendChild(row);
      });
    }
    
    // Initialize the page
    async function init() {
      try {
        contributors = await fetchAllContributors();
        renderTable(contributors);
        
        // Set up search functionality
        searchInput.addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const filtered = contributors.filter(c => 
            c.username.toLowerCase().includes(searchTerm)
          );
          renderTable(filtered);
        });
      } catch (error) {
        console.error("Error initializing:", error);
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="error">Failed to load contributor data. ${error.message}</td>
          </tr>
        `;
      }
    }
    
    // Start the application
    init();
  </script>
</body>
</html>